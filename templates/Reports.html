<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patient Information</title>
<link rel="stylesheet" href="{{ url_for('static', filename='./styles.css') }}">
<script src="{{ url_for('static', filename='./script.js') }}"></script>
</head>
<body>
  <div class="container">
    <h1>Patient Information</h1>
    <div>
      <label for="patientSelect">Select a patient:</label>
      <select id="patientSelect"></select>
    </div>
    <table id="patientTable">
      <thead>
        <tr>
          <th>Patient ID</th>
          <th>Age</th>
          <th>Gender</th>
          <th>Condition</th>
          <th>Referral Needed</th>
        </tr>
      </thead>
      <tbody id="patientData">
      
      </tbody>
    </table>
    <button id="exportPDF">Export to PDF</button>
    <a href="./index2.html" class="go-back-link">
        <button onclick="goBack()">Go Back</button>
    </a> 
  </div>
  <div id="csvData" style="display: none;">
    patientId,Age,Gender,Condition,Referral Needed
    P001,25,Female,Asthma,No
    P002,45,Male,Hypertension,Yes
    P003,35,Female,Arthritis,Yes
    P004,28,Male,Allergies,No
    P005,29,Female,Allergies,No
    P006,42,Male,Diabetes,Yes
    P007,36,Female,Hypertension,Yes
    P008,31,Male,Asthma,No
    P009,26,Female,Arthritis,Yes
    P010,48,Male,Obesity,Yes
    P011,35,Female,Depression,Yes
    P012,39,Male,Anxiety,Yes
    P013,33,Male,Allergies,No
    P014,27,Female,Diabetes,Yes
    P015,40,Male,Hypertension,Yes
    P016,32,Female,Depression,Yes
    P017,34,Male,Arthritis,Yes
    P018,37,Female,Allergies,No
    P019,30,Male,Asthma,No
    P020,41,Female,Diabetes,Yes
    P021,29,Male,Hypertension,Yes
    P022,38,Female,Arthritis,Yes
    P023,43,Male,Allergies,No
    P024,25,Female,Asthma,No
    P025,47,Male,Hypertension,Yes
    P026,36,Female,Diabetes,Yes
    P027,31,Male,Hypertension,Yes
    P028,26,Female,Depression,Yes
    P029,39,Male,Arthritis,Yes
    P030,30,Female,Allergies,No
    P031,44,Male,Diabetes,Yes
    P032,35,Female,Hypertension,Yes
    P033,28,Male,Asthma,No
    P034,37,Female,Depression,Yes
    P035,32,Male,Allergies,No
    P036,27,Female,Arthritis,Yes
    P037,41,Male,Diabetes,Yes
    P038,34,Female,Allergies,No
    P039,46,Male,Hypertension,Yes
    P040,38,Female,Arthritis,Yes
    P041,29,Male,Allergies,No
    P042,45,Female,Diabetes,Yes
    P043,40,Male,Hypertension,Yes
    P044,31,Female,Depression,Yes
    P045,26,Male,Asthma,No
    P046,33,Female,Arthritis,Yes
    P047,42,Male,Diabetes,Yes
    P048,37,Female,Hypertension,Yes
    P049,28,Male,Allergies,No
    P050,39,Female,Arthritis,Yes
    P051,44,Male,Diabetes,Yes
    P052,35,Female,Hypertension,Yes
    P053,30,Male,Asthma,No
    P054,41,Female,Depression,Yes
    P055,36,Male,Allergies,No
    P056,31,Female,Arthritis,Yes
    P057,43,Male,Diabetes,Yes
    P058,38,Female,Hypertension,Yes
    P059,27,Male,Asthma,No
    P060,32,Female,Depression,Yes
    P061,45,Male,Allergies,No
    P062,40,Female,Arthritis,Yes
    P063,35,Male,Diabetes,Yes
    P064,29,Female,Hypertension,Yes
    P065,46,Male,Depression,Yes
    P066,37,Female,Allergies,No
    P067,33,Male,Arthritis,Yes
    P068,48,Female,Diabetes,Yes
    P069,31,Male,Hypertension,Yes
    P070,26,Female,Depression,Yes
    P071,42,Male,Allergies,No
    P072,39,Female,Arthritis,Yes
    P073,34,Male,Diabetes,Yes
    P074,29,Female,Hypertension,Yes
    P075,43,Male,Depression,Yes
    P076,38,Female,Allergies,No
    P077,32,Male,Arthritis,Yes
    P078,47,Female,Diabetes,Yes
    P079,36,Male,Hypertension,Yes
    P080,31,Female,Depression,Yes
    P081,45,Male,Allergies,No
    P082,40,Female,Arthritis,Yes
    P083,35,Male,Diabetes,Yes
    P084,29,Female,Hypertension,Yes
    P085,46,Male,Depression,Yes
    P086,41,Female,Allergies,No
    P087,37,Male,Arthritis,Yes
    P088,48,Female,Diabetes,Yes
    P089,33,Male,Hypertension,Yes
    P090,28,Female,Depression,Yes
    P091,42,Male,Allergies,No
    P092,39,Female,Arthritis,Yes
    P093,34,Male,Diabetes,Yes
    P094,29,Female,Hypertension,Yes
    P095,43,Male,Depression,Yes
    P096,38,Female,Allergies,No
    P097,32,Male,Arthritis,Yes
    P098,47,Female,Diabetes,Yes
    P099,36,Male,Hypertension,Yes
    P100,31,Female,Depression,Yes
    P101,45,Male,Allergies,No
    P102,40,Female,Arthritis,Yes
    P103,35,Male,Diabetes,Yes
    P104,29,Female,Hypertension,Yes
    P105,46,Male,Depression,Yes
    P106,41,Female,Allergies,No
    P107,37,Male,Arthritis,Yes
    P108,48,Female,Diabetes,Yes
    P109,33,Male,Hypertension,Yes
    P110,28,Female,Depression,Yes
    P111,42,Male,Allergies,No
    P112,39,Female,Arthritis,Yes
    P113,34,Male,Diabetes,Yes
    P114,29,Female,Hypertension,Yes
    P115,43,Male,Depression,Yes
    P116,38,Female,Allergies,No
    P117,32,Male,Arthritis,Yes
    P118,47,Female,Diabetes,Yes
    P119,36,Male,Hypertension,Yes
    P120,31,Female,Depression,Yes
    P121,45,Male,Allergies,No
    P122,40,Female,Arthritis,Yes
    P123,35,Male,Diabetes,Yes
    P124,29,Female,Hypertension,Yes
    P125,46,Male,Depression,Yes
    P126,41,Female,Allergies,No
    P127,37,Male,Arthritis,Yes
    P128,48,Female,Diabetes,Yes
    P129,33,Male,Hypertension,Yes
    P130,28,Female,Depression,Yes
    P131,42,Male,Allergies,No
    P132,39,Female,Arthritis,Yes
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        var csvData = document.getElementById('csvData').innerText.trim();
        populatePatientSelect(csvData);
    });

    var patients = [];

    function populatePatientSelect(csvData) {
        var parsedData = csvData.split('\n').map(function(line) {
            return line.split(',');
        });

        patients = parsedData.slice(1).map(function(row) {
            return {
                'Patient ID': row[0],
                'Age': row[1],
                'Gender': row[2],
                'Condition': row[3],
                'Referral Needed': row[4]
            };
        });

        var select = document.getElementById('patientSelect');
        patients.forEach(function(patient, index) {
            var option = document.createElement('option');
            option.text = patient['Patient ID'];
            option.value = index;
            select.appendChild(option);
        });

        select.addEventListener('change', function() {
            var selectedIndex = parseInt(this.value);
            displayPatient(selectedIndex);
        });

        displayPatient(0);
    }

    function displayPatient(index) {
        var patient = patients[index];
        var patientHTML = '';
        for (var key in patient) {
            patientHTML += `<td>${patient[key]}</td>`;
        }
        document.getElementById('patientData').innerHTML = `<tr>${patientHTML}</tr>`;
    }

    document.getElementById('exportPDF').addEventListener('click', function () {
        var selectedIndex = document.getElementById('patientSelect').value;
        exportToPDF(patients[selectedIndex]);
    });

    async function exportToPDF(patient) {
        console.log("Exporting to PDF...");
        try {
            const { PDFDocument, rgb } = PDFLib;

            const pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage();

            page.drawText(`Patient Information - ${patient['Patient ID']}`, {
                x: 50,
                y: 750,
                size: 24,
                color: rgb(0, 0, 0),
            });

            let y = 700;
            for (const [key, value] of Object.entries(patient)) {
                page.drawText(`${key}: ${value}`, {
                    x: 50,
                    y,
                    size: 12,
                    color: rgb(0, 0, 0),
                });
                y -= 20;
            }

            const pdfBytes = await pdfDoc.save();
            download(pdfBytes, "patient_information.pdf", "application/pdf");
            console.log("PDF Exported successfully.");
        } catch (error) {
            console.error("Error exporting PDF:", error);
            alert("An error occurred while exporting PDF. Please try again.");
        }
    }

    function download(data, filename, type) {
        const file = new Blob([data], { type: type });
        const a = document.createElement("a");
        const url = URL.createObjectURL(file);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 0);
    }

    function goBack() {
        window.history.back();
    }
  </script>
</body>
</html>
