<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patient Information</title>
<link rel="stylesheet" href="{{ url_for('static', filename='./styles.css') }}">
<script src="{{ url_for('static', filename='./script.js') }}"></script>
</head>
<body>
  <div class="container">
    <h1>Patient Information</h1>
    <div>
      <label for="patientSelect">Select a patient:</label>
      <select id="patientSelect"></select>
    </div>
    <table id="patientTable">
      <thead>
        <tr>
          <th>Patient ID</th>
          <th>Age</th>
          <th>Gender</th>
          <th>Condition</th>
          <th>Referral Needed</th>
        </tr>
      </thead>
      <tbody id="patientData">
      
      </tbody>
    </table>
    <button id="exportPDF">Export to PDF</button>
    <a href="./index2.html" class="go-back-link">
        <button onclick="goBack()">Go Back</button>
    </a> 
  </div>
  <div id="csvData" style="display: none;">
    patientId,Age,Gender,Condition,Referral Needed
    P001,25,Female,Asthma,No
    P002,45,Male,Hypertension,Yes
    P003,35,Female,Arthritis,Yes
    P004,28,Male,Allergies,No
    P005,29,Female,Allergies,No
    P006,42,Male,Diabetes,Yes
    P007,36,Female,Hypertension,Yes
    P008,31,Male,Asthma,No
    P009,26,Female,Arthritis,Yes
    P010,48,Male,Obesity,Yes
    P011,35,Female,Depression,Yes
    P012,39,Male,Anxiety,Yes
    P013,33,Male,Allergies,No
    P014,27,Female,Diabetes,Yes
    P015,40,Male,Hypertension,Yes
    P016,32,Female,Depression,Yes
    P017,34,Male,Arthritis,Yes
    P018,37,Female,Allergies,No
    P019,30,Male,Asthma,No
    P020,41,Female,Diabetes,Yes
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        var csvData = document.getElementById('csvData').innerText.trim();
        populatePatientSelect(csvData);
    });

    var patients = [];

    function populatePatientSelect(csvData) {
        var parsedData = csvData.split('\n').map(function(line) {
            return line.split(',');
        });

        patients = parsedData.slice(1).map(function(row) {
            return {
                'Patient ID': row[0],
                'Age': row[1],
                'Gender': row[2],
                'Condition': row[3],
                'Referral Needed': row[4]
            };
        });

        var select = document.getElementById('patientSelect');
        patients.forEach(function(patient, index) {
            var option = document.createElement('option');
            option.text = patient['Patient ID'];
            option.value = index;
            select.appendChild(option);
        });

        select.addEventListener('change', function() {
            var selectedIndex = parseInt(this.value);
            displayPatient(selectedIndex);
        });

        displayPatient(0);
    }

    function displayPatient(index) {
        var patient = patients[index];
        var patientHTML = '';
        for (var key in patient) {
            patientHTML += `<td>${patient[key]}</td>`;
        }
        document.getElementById('patientData').innerHTML = `<tr>${patientHTML}</tr>`;
    }

    document.getElementById('exportPDF').addEventListener('click', function () {
        var selectedIndex = document.getElementById('patientSelect').value;
        exportToPDF(patients[selectedIndex]);
    });

    async function exportToPDF(patient) {
        console.log("Exporting to PDF...");
        try {
            const { PDFDocument, rgb } = PDFLib;

            const pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage();

            page.drawText(`Patient Information - ${patient['Patient ID']}`, {
                x: 50,
                y: 750,
                size: 24,
                color: rgb(0, 0, 0),
            });

            let y = 700;
            for (const [key, value] of Object.entries(patient)) {
                page.drawText(`${key}: ${value}`, {
                    x: 50,
                    y,
                    size: 12,
                    color: rgb(0, 0, 0),
                });
                y -= 20;
            }

            const pdfBytes = await pdfDoc.save();
            download(pdfBytes, "patient_information.pdf", "application/pdf");
            console.log("PDF Exported successfully.");
        } catch (error) {
            console.error("Error exporting PDF:", error);
            alert("An error occurred while exporting PDF. Please try again.");
        }
    }

    function download(data, filename, type) {
        const file = new Blob([data], { type: type });
        const a = document.createElement("a");
        const url = URL.createObjectURL(file);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 0);
    }

    function goBack() {
        window.history.back();
    }
  </script>
</body>
</html>
